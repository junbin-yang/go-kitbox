name: CI

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: '1.21'

            - name: golangci-lint
              uses: golangci/golangci-lint-action@v3
              with:
                  version: latest
                  args: ./pkg/... ./internal/...

    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: '1.21'

            - name: Test
              run: go test -v -coverprofile=coverage.out $(go list ./... | grep -v /examples/)

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage.out
                  token: ${{ secrets.CODECOV_TOKEN }}

    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: '1.21'

            - name: Build binpack-cli
              run: |
                  cd pkg/binpack/generator/cmd/binpack-cli
                  go build -v -o binpack-cli

            - name: Test binpack-cli validate
              run: |
                  cd pkg/binpack/generator/cmd/binpack-cli
                  ./binpack-cli validate -pkg ../../../../../internal/binpack/testdata/validate -type ValidPacket

    benchmark:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: '1.21'

            - name: Run benchmarks
              run: go test -bench=. -benchmem -run=^$ $(go list ./... | grep -v /examples/)
